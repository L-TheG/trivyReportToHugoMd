import fs from "fs";
import { mergeChildrenWithParentObjs, sanitiseStringForMarkdown, reformatString } from "./utils.js";
import { vulnTemplate, outDir } from "./consts.js";

export function extractVulnerabilities(trivyJsonReport) {
  const reportEntries = trivyJsonReport.Vulnerabilities;

  // remove all entries that have no results
  let targetableComponents = reportEntries.filter((entry) => entry.hasOwnProperty("Results"));

  let flattenedTargets = mergeChildrenWithParentObjs(targetableComponents, "Results");

  // remove all targets without vulnerabilities
  let vulnerableComponents = flattenedTargets.filter((target) => target.hasOwnProperty("Vulnerabilities"));

  let vulnerabilities = mergeChildrenWithParentObjs(vulnerableComponents, "Vulnerabilities");
  let filteredVulnerabilities = vulnerabilities.filter((vuln) => vuln.Severity === "HIGH" || vuln.Severity === "CRITICAL");
  return filteredVulnerabilities;
}

export async function createVulnerabilityFiles(vulnerabilities) {
  const vulnerabilityMarkdownTemplate = (await fs.promises.readFile(vulnTemplate)).toString();

  vulnerabilities.forEach((vuln, index) => {
    let markdown = buildVulnMarkdown(vulnerabilityMarkdownTemplate, vuln);

    // create directory
    let dir = outDir + "/" + "Vulnerabilities" + "/" + vuln.Severity + "/" + vuln.Namespace;
    if (!fs.existsSync(dir)) {
      fs.mkdirSync(dir, { recursive: true });
    }
    fs.writeFileSync(dir + "/" + vuln.VulnerabilityID + "-" + index + ".md", markdown);
  });
}

// Every part that is to be replaced has _+first char as lowercase in the template
// ex: JSON Field Class is represented by _class in the template. _class will be replaced by the value of the Class field in the JSON object
function buildVulnMarkdown(template, vulnerabilitiy) {
  for (const [key, value] of Object.entries(vulnerabilitiy)) {
    const replaceString = reformatString(key);
    const regexp = new RegExp(`${replaceString}`, "gi");

    // convert object into json format
    if (typeof value === "object" && !Array.isArray(value)) {
      let objString = JSON.stringify(value, null, 2);
      template = template.replace(regexp, objString);
    }

    // create expandable markdown list element
    if (Array.isArray(value)) {
      let arrayString = '{{%expand "' + key + '" %}}\n\n';
      value.forEach((element) => {
        arrayString = arrayString + "- " + element + "\n";
      });
      arrayString = arrayString + "{{% /expand%}}\n";
      template = template.replace(regexp, arrayString);

      // simply exchange template with object value
    } else {
      let stringToReplace = sanitiseStringForMarkdown(value);

      template = template.replace(regexp, stringToReplace);
    }
  }

  return template;
}
